<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ä¸Šèœå¸‚åœºï¼šæ†ç§¤æ¨¡æ‹Ÿå™¨ (V10.1 ä¿®æ­£ç‰ˆ)</title>
    <style>
        :root {
            --wood-dark: #5d4037;
            --wood-light: #8d6e63;
            --bg-paper: #fdf5e6;
            --market-red: #c62828;
            --market-green: #2e7d32;
            --market-blue: #1565c0;
            --text-color: #3e2723;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "KaiTi", "æ¥·ä½“", "STKaiti", serif;
            margin: 0; padding: 0;
            background-color: var(--bg-paper);
            color: var(--text-color);
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        header {
            background: var(--market-red); color: #fff; 
            padding: 8px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .mode-switch {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5);
            padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer;
        }

        #app-container { display: flex; flex: 1; height: calc(100vh - 50px); }

        /* å·¦ä¾§è´§æ¶ */
        #market-stall {
            width: 240px; background: #fff3e0;
            border-right: 2px solid var(--wood-dark); padding: 10px;
            overflow-y: auto; display: flex; flex-direction: column;
        }
        #market-stall.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(0.5); }

        .category-title {
            font-weight: bold; margin: 10px 0 5px; color: var(--wood-dark);
            border-bottom: 2px dotted var(--wood-dark); padding-bottom: 2px;
        }
        .item-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .market-item {
            background: #fff; border: 1px solid var(--wood-light);
            border-radius: 8px; padding: 8px; text-align: center;
            cursor: pointer; box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }
        .market-item:active { transform: translateY(2px); box-shadow: none; background: #f5f5f5; }
        .market-item .icon { font-size: 26px; display: block; }
        .market-item .name { font-size: 14px; font-weight: bold; }
        
        /* ä¸­é—´èˆå° */
        #scale-stage {
            flex: 1; position: relative;
            background: radial-gradient(circle, #fff 0%, #eee 100%);
            display: flex; flex-direction: column; overflow: hidden;
        }

        #toast-msg {
            position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #fff; padding: 8px 20px;
            border-radius: 20px; font-size: 1rem; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 100;
        }

        #top-status-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 8px; text-align: center; pointer-events: none; z-index: 5;
        }
        #vendor-order-display {
            background: #fff; border: 2px solid var(--market-red); color: var(--market-red);
            padding: 5px 20px; border-radius: 20px; font-weight: bold;
            display: inline-block; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #instruction-text {
            background: rgba(255,255,255,0.8); padding: 4px 12px; border-radius: 15px;
            font-size: 0.9rem; color: #555; display: inline-block; margin-top: 5px;
        }

        #zoom-controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.9); padding: 5px 15px;
            border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 10px; font-size: 0.9rem;
            border: 1px solid #ccc; z-index: 5;
        }
        input[type=range] { width: 150px; cursor: pointer; }

        canvas { width: 100%; height: 100%; cursor: grab; touch-action: none; }
        canvas:active { cursor: grabbing; }

        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 20;
            display: none; justify-content: center; align-items: center;
        }
        .result-card {
            background: #fff; padding: 25px; border-radius: 10px; width: 320px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 3px solid var(--wood-dark);
        }
        .result-title { font-size: 1.6rem; margin-bottom: 10px; font-weight: bold; }
        .result-detail { margin-bottom: 20px; color: #555; line-height: 1.6; }

        /* å³ä¾§é¢æ¿ */
        #controls-panel {
            width: 280px; background: #fff3e0;
            border-left: 2px solid var(--wood-dark); padding: 15px;
            display: flex; flex-direction: column; gap: 12px; overflow-y: auto;
        }

        .panel-box {
            background: #fff; padding: 12px; border-radius: 8px;
            border: 1px solid var(--wood-light);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: opacity 0.3s;
        }
        .panel-box.disabled { opacity: 0.5; pointer-events: none; }
        .panel-box.highlight { border: 2px solid var(--market-blue); background: #e3f2fd; }

        .basket-list { max-height: 200px; overflow-y: auto; padding: 0; margin: 0; list-style: none; font-size: 0.9rem; }
        .basket-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #ddd; padding: 6px 0; }
        
        .qty-control { display: flex; align-items: center; gap: 5px; background: #f0f0f0; border-radius: 15px; padding: 2px; }
        .qty-btn { width: 24px; height: 24px; border-radius: 50%; border: none; background: #fff; cursor: pointer; font-weight: bold; }
        
        /* æ•°é‡æ˜¾ç¤º/è¾“å…¥æ¡†æ ·å¼ */
        .qty-val { 
            min-width: 35px; text-align: center; font-weight: bold; cursor: pointer; 
            border-bottom: 1px dashed #999; padding: 0 4px; 
        }
        .qty-val:hover { background: #fff; color: var(--market-blue); }
        
        .qty-input-inline { 
            width: 65px; 
            padding: 4px; text-align: center; border: 1px solid var(--market-blue); 
            border-radius: 4px; font-size: 1rem; font-weight: bold;
            -moz-appearance: textfield;
        }
        .qty-input-inline::-webkit-outer-spin-button,
        .qty-input-inline::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .btn {
            background: var(--wood-dark); color: #fff; border: none;
            padding: 10px; width: 100%; border-radius: 6px;
            font-family: inherit; font-size: 1rem; cursor: pointer; margin-top: 8px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-green { background: var(--market-green); }
        .btn-blue { background: var(--market-blue); }
        .btn-red { background: var(--market-red); }
        .btn-outline { background: transparent; border: 1px solid var(--wood-dark); color: var(--wood-dark); }
        .btn-outline:hover { background: #eee; }
        
        .input-group { display: flex; gap: 8px; margin-top: 5px; }
        input[type="number"] {
            flex: 1; padding: 8px; border: 2px solid var(--wood-light);
            border-radius: 6px; font-family: inherit; font-size: 1.1rem; text-align: center;
        }
        
        #vendor-haggle-panel { display: none; }

        @media (max-width: 768px) {
            #app-container { flex-direction: column; overflow-y: auto; }
            #market-stall, #controls-panel { width: 100%; height: auto; flex: none; }
            #market-stall { height: 160px; border-right: none; border-bottom: 2px solid var(--wood-dark); }
            #controls-panel { border-left: none; border-top: 2px solid var(--wood-dark); }
            #scale-stage { min-height: 350px; }
        }
    </style>
</head>
<body>

<header>
    <div class="mode-switch" onclick="switchGameMode()">ğŸ”„ åˆ‡æ¢æ¨¡å¼</div>
    <h1 id="page-title">ğŸ›’ ç½‘ä¸Šèœå¸‚åœº</h1>
    <div style="font-size:0.8rem; opacity:0.8;">V10.1 ä¿®æ­£ç§¯åˆ†ç‰ˆ</div>
</header>

<div id="app-container">
    <aside id="market-stall">
        <div class="category-title">ğŸ¥¬ è”¬èœåŒº</div>
        <div class="item-grid" id="veg-grid"></div>
        <div class="category-title">ğŸ æ°´æœåŒº</div>
        <div class="item-grid" id="fruit-grid"></div>
        <div class="category-title">ğŸ¥© è‚‰ç±»/å¹²è´§</div>
        <div class="item-grid" id="meat-grid"></div>
    </aside>

    <main id="scale-stage">
        <div id="toast-msg">æç¤ºä¿¡æ¯</div>
        <div id="top-status-bar">
            <div id="vendor-order-display" style="display:none;"></div>
            <br>
            <div id="instruction-text">ç‚¹å‡»å·¦ä¾§åŠ èœï¼Œæ‹–åŠ¨ç§¤ç £ç§°é‡</div>
        </div>
        <canvas id="simCanvas"></canvas>
        <div id="zoom-controls">
            <span>ğŸ” è§†é‡</span>
            <input type="range" id="zoom-slider" min="0.6" max="1.5" step="0.05" value="0.9">
            <span id="zoom-val">90%</span>
        </div>
        <div id="result-overlay">
            <div class="result-card">
                <div class="result-title" id="res-title">ç»“æœ</div>
                <div class="result-detail" id="res-detail">è¯¦æƒ…...</div>
                <div style="display:flex; gap:10px; flex-direction: column;">
                    <button class="btn btn-green" onclick="nextRound()">âœ… ä¸‹ä¸€å•</button>
                    <button class="btn btn-outline" onclick="closeResult()">âŒ æš‚ä¸ç»“ç®—</button>
                </div>
            </div>
        </div>
    </main>

    <aside id="controls-panel">
        <div class="panel-box">
            <h3 style="margin:5px 0 10px;">ğŸ† æˆ˜ç»©</h3>
            <div style="display:flex; justify-content:space-between; font-size:1rem;">
                <span>ç§¯åˆ†: <b id="score-val" style="color:var(--market-red)">0</b></span>
                <span>è¿å¯¹: <b id="streak-val">0</b></span>
            </div>
        </div>

        <div id="mode-customer-ui">
            <div class="panel-box" id="basket-panel">
                <h4 style="margin:0 0 10px 0;">ğŸ§º è´­ç‰©ç¯®</h4>
                <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">ä¸Šé™: 3000g</div>
                <ul class="basket-list" id="basket-ul">
                    <li style="color:#999; text-align:center;">æš‚æ— ç‰©å“</li>
                </ul>
                <button class="btn btn-green" id="btn-start-weigh">å¼€å§‹ç§°é‡</button>
            </div>

            <div class="panel-box disabled" id="weigh-panel">
                <h4>âš–ï¸ è¯»æ•°éªŒè¯</h4>
                <div class="input-group">
                    <input type="number" id="weight-input" placeholder="è¾“å…¥å…‹æ•°">
                    <button class="btn btn-green" style="width:auto;" id="btn-submit">ç¡®å®š</button>
                </div>
                <button class="btn btn-outline" style="margin-top:10px; font-size:0.9rem;" onclick="backToShopping()">â¬… ç»§ç»­ä¹°èœ</button>
            </div>
        </div>

        <div id="mode-vendor-ui" style="display:none;">
            <div class="panel-box" id="vendor-op-panel">
                <h4>ğŸ‘¨â€ğŸ³ ç»è¥æ“ä½œ</h4>
                <div id="vendor-controls" style="margin:10px 0;"></div>
                
                <div id="vendor-main-btns">
                    <button class="btn btn-green" id="btn-vendor-done">ç§°å¥½äº† (ä¸¥æ ¼)</button>
                    <button class="btn btn-blue" id="btn-vendor-haggle-mode">å®ç§°å®ç®— (åå•†)</button>
                </div>

                <div id="vendor-haggle-panel">
                    <hr style="margin:10px 0; border:0; border-top:1px dashed #ccc;">
                    <div style="font-size:0.9rem; color:var(--market-blue); margin-bottom:5px;">ğŸ‘€ è¯·çœ‹å·¦ä¾§ç§¤æ†è¯»æ•°</div>
                    <div class="input-group">
                        <input type="number" id="haggle-input" placeholder="å®é™…å…‹æ•°">
                    </div>
                    <button class="btn btn-blue" id="btn-haggle-confirm" style="margin-top:5px;">ğŸ«±ğŸ»â€ğŸ«²ğŸ¼ ç¡®è®¤æˆäº¤</button>
                    <button class="btn btn-outline" id="btn-haggle-cancel" style="margin-top:5px;">â¬… è¿”å›</button>
                </div>
            </div>
        </div>

        <button class="btn btn-red" id="btn-reset">æ¸…ç©ºé‡ç½®</button>
    </aside>
</div>

<script>
/* * V10.1 ä¿®æ­£ç‰ˆ
 * 1. ç‰©ç†è°ƒæ•´ï¼šRight Torque > Left Torque -> æ†å­å³ä¾§ç¿˜èµ· (Angle < 0)ï¼Œæ»¡è¶³"è¶Šå¾€å³è¶Šé«˜"ã€‚
 * 2. ç§¯åˆ†è°ƒæ•´ï¼šä½¿ç”¨ Math.abs(diff) ç»å¯¹è¯¯å·®è®¡ç®—ã€‚
 */

const ITEMS_DB = [
    { id: 'potato', name: 'åœŸè±†', category: 'veg', base: 150, var: 30, icon: 'ğŸ¥”' },
    { id: 'tomato', name: 'ç•ªèŒ„', category: 'veg', base: 120, var: 20, icon: 'ğŸ…' },
    { id: 'cabbage', name: 'ç™½èœ', category: 'veg', base: 800, var: 100, icon: 'ğŸ¥¬' },
    { id: 'pepper', name: 'è¾£æ¤’', category: 'veg', base: 15, var: 5, icon: 'ğŸŒ¶ï¸', small: true },
    { id: 'garlic', name: 'å¤§è’œ', category: 'veg', base: 20, var: 5, icon: 'ğŸ§„', small: true },
    { id: 'apple', name: 'è‹¹æœ', category: 'fruit', base: 180, var: 20, icon: 'ğŸ' },
    { id: 'banana', name: 'é¦™è•‰', category: 'fruit', base: 150, var: 15, icon: 'ğŸŒ' },
    { id: 'grape', name: 'è‘¡è„', category: 'fruit', base: 300, var: 50, icon: 'ğŸ‡' },
    { id: 'pork', name: 'çŒªè‚‰', category: 'meat', base: 200, var: 20, icon: 'ğŸ¥©' },
    { id: 'fish', name: 'é±¼', category: 'meat', base: 700, var: 100, icon: 'ğŸŸ' },
    { id: 'rice', name: 'å¤§ç±³', category: 'meat', base: 500, var: 0, icon: 'ğŸš' },
];

const CONFIG = {
    scaleRange: 3500,
    maxWeight: 3000,
    panDist: 80,
    weightMass: 600,
    tolerance: 3, 
};

const state = {
    mode: 'customer', 
    basket: [], 
    totalWeight: 0,         
    smoothWeight: 0,        
    stage: 'shopping',
    vendorTarget: { weight: 0, itemName: '', itemId: '' },
    physics: { angle: 25, velocity: 0, weightPos: 20, balanced: false },
    view: { zoom: 0.9, isDragging: false },
    game: { score: 0, streak: 0 }
};

/* --- Init --- */
function initMarket() {
    ITEMS_DB.forEach(item => {
        const div = document.createElement('div');
        div.className = 'market-item';
        div.innerHTML = `<span class="icon">${item.icon}</span><span class="name">${item.name}</span>`;
        div.onclick = () => handleShelfClick(item);
        if(item.category === 'veg') document.getElementById('veg-grid').appendChild(div);
        else if(item.category === 'fruit') document.getElementById('fruit-grid').appendChild(div);
        else document.getElementById('meat-grid').appendChild(div);
    });
}

function handleShelfClick(itemDef) {
    if (state.mode === 'customer' && state.stage !== 'shopping') {
        showToast("æ­£åœ¨ç§°é‡ï¼Œè¯·å…ˆç»“æŸæˆ–ç‚¹å‡»â€œç»§ç»­ä¹°èœâ€"); return;
    }
    if (state.mode === 'vendor') {
        if (!state.vendorTarget.itemId) { showToast("è¯·å…ˆç‚¹å‡»é‡ç½®å¼€å§‹æ–°ä¸€å•"); return; }
        if (itemDef.id !== state.vendorTarget.itemId) { showToast("é¡¾å®¢åªè¦ " + state.vendorTarget.itemName); return; }
    }
    const count = (itemDef.small && state.basket.filter(i=>i.name===itemDef.name).length===0) ? 5 : 1;
    addItem(itemDef, count);
}

function addItem(itemDef, count) {
    let addedWeight = 0;
    for(let i=0; i<count; i++) addedWeight += itemDef.base; 
    
    if (state.totalWeight + addedWeight > CONFIG.maxWeight) {
        showToast(`å¤ªé‡äº†ï¼ä¸Šé™ ${CONFIG.maxWeight}g`); return;
    }

    for(let i=0; i<count; i++) {
        const w = itemDef.base + (Math.random() * itemDef.var * 2 - itemDef.var);
        state.basket.push({ 
            id: itemDef.id, name: itemDef.name, weight: w, icon: itemDef.icon, baseDef: itemDef,
            visualX: (Math.random() * 40 - 20), visualY: (Math.random() * 10 - 5)
        });
        state.totalWeight += w;
    }
    updateBasketUI();
}

function removeItem(itemName) {
    for (let i = state.basket.length - 1; i >= 0; i--) {
        if (state.basket[i].name === itemName) {
            state.totalWeight -= state.basket[i].weight;
            state.basket.splice(i, 1);
            break;
        }
    }
    if (state.basket.length === 0) state.totalWeight = 0;
    updateBasketUI();
}

function updateItemCount(itemName, newCount) {
    const currentItems = state.basket.filter(i => i.name === itemName);
    const diff = newCount - currentItems.length;
    if (diff > 0) {
        const def = currentItems.length > 0 ? currentItems[0].baseDef : ITEMS_DB.find(i=>i.name===itemName);
        if(def) addItem(def, diff);
    } else if (diff < 0) {
        for(let i=0; i<Math.abs(diff); i++) removeItem(itemName);
    }
}

function updateBasketUI() {
    const ul = document.getElementById('basket-ul');
    ul.innerHTML = '';
    const groups = {};
    state.basket.forEach(item => {
        if (!groups[item.name]) groups[item.name] = { count: 0, icon: item.icon, def: item.baseDef };
        groups[item.name].count++;
    });

    if (Object.keys(groups).length === 0) {
        ul.innerHTML = '<li style="color:#999; text-align:center; padding:10px;">æš‚æ— ç‰©å“</li>';
        if(state.mode==='vendor') document.getElementById('vendor-controls').innerHTML = 'è¯·ç‚¹å‡»è´§æ¶æ·»åŠ å•†å“';
        return;
    }

    const createRow = (name, data) => {
        const div = document.createElement('div');
        div.className = 'qty-control';
        
        const btnDec = document.createElement('button'); btnDec.className = 'qty-btn'; btnDec.innerText = '-';
        btnDec.onclick = () => removeItem(name);

        const btnInc = document.createElement('button'); btnInc.className = 'qty-btn'; btnInc.innerText = '+';
        btnInc.onclick = () => addItem(data.def, 1);

        const qtySpan = document.createElement('span'); 
        qtySpan.className = 'qty-val'; 
        qtySpan.innerText = data.count;
        
        qtySpan.onclick = (e) => {
            e.stopPropagation(); 
            if(qtySpan.querySelector('input')) return; 

            const oldVal = data.count;
            qtySpan.innerText = ''; 
            
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'qty-input-inline';
            input.value = oldVal;
            
            const save = () => {
                let val = parseInt(input.value);
                if(isNaN(val) || val < 0) val = 0;
                if(val > 300) val = 300; 
                updateItemCount(name, val); 
            };

            input.onblur = save;
            input.onkeydown = (ev) => { if(ev.key === 'Enter') { input.blur(); } };
            
            qtySpan.appendChild(input);
            input.focus();
        };

        div.appendChild(btnDec);
        div.appendChild(qtySpan);
        div.appendChild(btnInc);
        return div;
    };

    for (let [name, data] of Object.entries(groups)) {
        const li = document.createElement('li');
        li.className = 'basket-item';
        li.innerHTML = `<span style="font-weight:bold">${data.icon} ${name}</span>`;
        li.appendChild(createRow(name, data));
        ul.appendChild(li);
    }

    if (state.mode === 'vendor') {
        const vContainer = document.getElementById('vendor-controls');
        vContainer.innerHTML = '';
        const targetName = state.vendorTarget.itemName;
        if (targetName && groups[targetName]) {
             const row = document.createElement('div');
             row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems='center';
             row.innerHTML = `<span style="font-weight:bold">${groups[targetName].icon} ${targetName}</span>`;
             row.appendChild(createRow(targetName, groups[targetName]));
             vContainer.appendChild(row);
        }
    }
}

/* --- Physics Engine V10.1 (Inverted Logic) --- */
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');
const zoomSlider = document.getElementById('zoom-slider');

zoomSlider.oninput = function() {
    state.view.zoom = parseFloat(this.value);
    document.getElementById('zoom-val').innerText = Math.round(state.view.zoom * 100) + "%";
};
function resizeCanvas() {
    canvas.width = canvas.parentElement.clientWidth;
    canvas.height = canvas.parentElement.clientHeight;
}
window.addEventListener('resize', resizeCanvas);

function loop() {
    updatePhysics();
    drawScene();
    requestAnimationFrame(loop);
}

function updatePhysics() {
    const P = state.physics;
    
    // 1. è®¡ç®—å¹³æ»‘é‡é‡ï¼ˆæ¨¡æ‹Ÿæ”¾èœæ—¶çš„æ™ƒåŠ¨ç¼“å†²ï¼‰
    const diffWeight = state.totalWeight - state.smoothWeight;
    state.smoothWeight += diffWeight * 0.1; 
    
    // 2. è®¡ç®—åŠ›çŸ© (Torque = Force * Distance)
    // å·¦ä¾§åŠ›çŸ©ï¼šèœå“é‡é‡ * ç§¤ç›˜è·ç¦»
    const torqueLeft = state.smoothWeight * CONFIG.panDist;
    
    // å³ä¾§åŠ›çŸ©ï¼šç§¤ç £è´¨é‡ * ç§¤ç £ä½ç½®(è·ç¦»)
    const torqueRight = CONFIG.weightMass * P.weightPos;
    
    // 3. è®¡ç®—ç›®æ ‡è§’åº¦
    // ç‰©ç†é€»è¾‘ï¼š
    // å¦‚æœ å³è¾¹åŠ›çŸ©(torqueRight) > å·¦è¾¹åŠ›çŸ©(torqueLeft) -> ç»“æœä¸ºæ­£ -> é¡ºæ—¶é’ˆæ—‹è½¬ -> å³è¾¹ä¸‹æ²‰
    // å¦‚æœ å·¦è¾¹åŠ›çŸ©(torqueLeft) > å³è¾¹åŠ›çŸ©(torqueRight) -> ç»“æœä¸ºè´Ÿ -> é€†æ—¶é’ˆæ—‹è½¬ -> å·¦è¾¹ä¸‹æ²‰
    let targetAngle = (torqueRight - torqueLeft) / 1000; // è°ƒæ•´åˆ†æ¯å¯æ”¹å˜çµæ•åº¦
    
    // 4. è§’åº¦é™åˆ¶ï¼ˆé˜²æ­¢è½¬åœˆåœˆï¼‰
    targetAngle = Math.max(-28, Math.min(28, targetAngle));
    
    // 5. å¼¹ç°§é˜»å°¼è¿åŠ¨ç³»ç»Ÿ (æ ¸å¿ƒåŠ¨ç”»é€»è¾‘)
    // é€Ÿåº¦ += (ç›®æ ‡è§’åº¦ - å½“å‰è§’åº¦) * å¼¹æ€§ç³»æ•°
    P.velocity += (targetAngle - P.angle) * 0.04;
    
    // é€Ÿåº¦è¡°å‡ (æ¨¡æ‹Ÿæ‘©æ“¦åŠ›ï¼Œé˜²æ­¢æ°¸è¿œæ‘†åŠ¨)
    P.velocity *= 0.90; 
    
    // æ›´æ–°è§’åº¦
    P.angle += P.velocity;
    
    // 6. åˆ¤æ–­æ˜¯å¦å¹³è¡¡ (è¯¯å·®èŒƒå›´å†…)
    state.physics.balanced = Math.abs(P.angle) < CONFIG.tolerance;
}

function drawScene() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const cx = canvas.width / 2;
    const cy = 100 * state.view.zoom; 
    const angleRad = state.physics.angle * Math.PI / 180;
    const zoom = state.view.zoom;

    ctx.save();
    ctx.translate(cx, cy);
    ctx.scale(zoom, zoom);
    
    // æç»³
    ctx.beginPath(); ctx.moveTo(0, -100); ctx.lineTo(0, 0);
    ctx.lineWidth = 4/zoom; ctx.strokeStyle = '#8d6e63'; ctx.stroke();

    // æ—‹è½¬æ†
    ctx.rotate(angleRad);
    const beamRight = (canvas.width / zoom) * 0.8;
    const beamLeft = -CONFIG.panDist - 40;
    const grad = ctx.createLinearGradient(0, -5, 0, 5);
    grad.addColorStop(0, '#5d4037'); grad.addColorStop(1, '#8d6e63');
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.moveTo(beamLeft, -6); ctx.lineTo(beamRight, -3); ctx.lineTo(beamRight, 3); ctx.lineTo(beamLeft, 6); ctx.fill();

    // åˆ»åº¦
    ctx.fillStyle = '#fff'; ctx.textAlign = 'center';
    for (let g = 0; g <= CONFIG.scaleRange; g += 50) {
        const px = (g * CONFIG.panDist) / CONFIG.weightMass;
        if (px > beamRight) break;
        if (g % 500 === 0) {
            ctx.fillStyle = 'gold'; ctx.fillRect(px - 1, -6, 2, 12);
            ctx.save(); ctx.translate(px, -22); 
            ctx.rotate(-angleRad); 
            ctx.fillStyle = '#3e2723'; ctx.font = 'bold 12px Arial'; 
            ctx.fillText(g, 0, 0); 
            ctx.restore();
        } else if (g % 100 === 0 && zoom > 0.7) {
            ctx.fillStyle = '#eee'; ctx.fillRect(px - 0.5, -4, 1, 8);
        }
    }

    // ç§¤ç›˜
    ctx.save();
    ctx.translate(-CONFIG.panDist, 0);
    ctx.rotate(-angleRad); 
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-25,90); ctx.moveTo(0,0); ctx.lineTo(25,90);
    ctx.strokeStyle = '#333'; ctx.lineWidth = 1/zoom; ctx.stroke();
    ctx.beginPath(); ctx.ellipse(0, 90, 60, 15, 0, 0, Math.PI * 2);
    ctx.fillStyle = '#222'; ctx.fill();
    
    const groups = {};
    state.basket.forEach(i => {
        if(!groups[i.name]) groups[i.name] = { icon: i.icon, count: 0 };
        groups[i.name].count++;
    });
    let drawIdx = 0;
    for(let name in groups) {
        const g = groups[name];
        const row = Math.floor(drawIdx / 2);
        const baseY = 80 - (row * 25);
        const baseX = (drawIdx % 2 === 0 ? -15 : 15);
        ctx.font = '28px Arial'; ctx.textAlign = 'center';
        ctx.fillText(g.icon, baseX, baseY);
        if(g.count > 1) {
            const badge = `x${g.count}`;
            ctx.font = 'bold 12px Arial';
            const tw = ctx.measureText(badge).width;
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.beginPath(); ctx.roundRect(baseX + 10, baseY - 10, tw+6, 16, 8); ctx.fill();
            ctx.fillStyle = '#d32f2f'; ctx.fillText(badge, baseX + 13 + tw/2, baseY + 2);
        }
        drawIdx++;
    }
    ctx.restore();

    // ç§¤ç £
    ctx.save();
    ctx.translate(state.physics.weightPos, 0);
    ctx.fillStyle = '#C0C0C0'; ctx.fillRect(-3, -7, 6, 14); ctx.strokeStyle = '#555'; ctx.lineWidth = 1; ctx.strokeRect(-3, -7, 6, 14);
    ctx.rotate(-angleRad); 
    ctx.beginPath(); ctx.moveTo(0, 7); ctx.lineTo(0, 45);
    ctx.strokeStyle = '#d32f2f'; ctx.lineWidth = 2/zoom; ctx.stroke();
    if (state.view.isDragging) { ctx.shadowColor = "rgba(255, 215, 0, 1)"; ctx.shadowBlur = 15; }
    ctx.fillStyle = '#444'; ctx.beginPath(); ctx.moveTo(-14,45); ctx.lineTo(14,45); ctx.lineTo(16,75); ctx.lineTo(-16,75); ctx.fill();
    ctx.shadowBlur = 0; 
    ctx.fillStyle = '#fff'; ctx.font = '10px Arial'; ctx.fillText("600g", -12, 60);
    ctx.restore();
    ctx.restore();
}

/* --- Interaction --- */
function getLogicX(evt) {
    const rect = canvas.getBoundingClientRect();
    const cx = (evt.touches ? evt.touches[0].clientX : evt.clientX) - rect.left;
    return (cx - canvas.width/2) / state.view.zoom;
}
canvas.addEventListener('mousedown', e => { if (getLogicX(e) > -50) state.view.isDragging = true; });
canvas.addEventListener('mousemove', e => { if (state.view.isDragging) { let d = getLogicX(e); d = Math.max(10, Math.min(d, (canvas.width/state.view.zoom)*0.9)); state.physics.weightPos = d; }});
window.addEventListener('mouseup', () => state.view.isDragging = false);
canvas.addEventListener('touchstart', e => { if (getLogicX(e) > -50) state.view.isDragging = true; }, {passive:false});
canvas.addEventListener('touchmove', e => { if (state.view.isDragging) { e.preventDefault(); let d = getLogicX(e); d = Math.max(10, Math.min(d, (canvas.width/state.view.zoom)*0.9)); state.physics.weightPos = d; }}, {passive:false});
window.addEventListener('touchend', () => state.view.isDragging = false);

function showToast(msg) {
    const t = document.getElementById('toast-msg');
    t.innerText = msg; t.style.opacity = 1;
    setTimeout(() => t.style.opacity = 0, 2000);
}

function switchGameMode() {
    state.mode = state.mode === 'customer' ? 'vendor' : 'customer';
    resetGame();
    document.getElementById('page-title').innerText = state.mode==='customer' ? 'ğŸ›’ ç½‘ä¸Šèœå¸‚åœº' : 'ğŸ‘¨â€ğŸ³ æˆ‘æ˜¯è€æ¿';
    document.getElementById('mode-customer-ui').style.display = state.mode==='customer' ? 'block' : 'none';
    document.getElementById('mode-vendor-ui').style.display = state.mode==='customer' ? 'none' : 'block';
    const vBar = document.getElementById('vendor-order-display');
    vBar.style.display = state.mode==='vendor' ? 'inline-block' : 'none';
    if(state.mode === 'vendor') startVendorRound();
    else updateInstruction("è¯·æ”¾å…¥èœå“ï¼Œç„¶åå¼€å§‹ç§°é‡", false);
}

function resetGame() {
    state.basket = []; state.totalWeight = 0; state.smoothWeight = 0;
    state.physics.angle = 25; state.physics.balanced = false;
    state.stage = state.mode === 'customer' ? 'shopping' : 'active';
    
    document.getElementById('market-stall').classList.remove('disabled');
    document.getElementById('market-stall').style.opacity = '1'; 
    document.getElementById('market-stall').style.pointerEvents = 'auto';

    document.getElementById('weight-input').value = '';
    document.getElementById('haggle-input').value = '';
    
    document.getElementById('basket-panel').classList.remove('disabled');
    document.getElementById('weigh-panel').classList.add('disabled');
    
    document.getElementById('vendor-main-btns').style.display = 'block';
    document.getElementById('vendor-haggle-panel').style.display = 'none';
    document.getElementById('vendor-op-panel').classList.remove('highlight');

    updateBasketUI();
    closeResult();
}

function updateInstruction(text, isError) {
    const el = document.getElementById('instruction-text');
    if(!text) { el.style.opacity = 0; return; }
    el.style.opacity = 1; el.innerText = text; el.style.color = isError ? 'var(--market-red)' : '#555';
}

function showResult(title, detail, isSuccess) {
    const overlay = document.getElementById('result-overlay');
    document.getElementById('res-title').innerText = title;
    document.getElementById('res-title').style.color = isSuccess ? 'var(--market-green)' : 'var(--market-red)';
    document.getElementById('res-detail').innerHTML = detail;
    overlay.style.display = 'flex';
    document.getElementById('score-val').innerText = state.game.score;
}
function closeResult() { document.getElementById('result-overlay').style.display = 'none'; }
function nextRound() { closeResult(); resetGame(); if(state.mode==='vendor') startVendorRound(); }

/* Buyer Logic - V10.1 Absolute Scoring */
document.getElementById('btn-start-weigh').onclick = () => {
    if(state.basket.length===0) return showToast("ç¯®å­æ˜¯ç©ºçš„ï¼");
    state.stage = 'weighing'; state.physics.weightPos = 20; 
    document.getElementById('basket-panel').classList.add('disabled');
    document.getElementById('weigh-panel').classList.remove('disabled');
    document.getElementById('market-stall').classList.add('disabled');
    updateInstruction("æ‹–åŠ¨ç§¤ç £ï¼Œä½¿æ†ç§¤å¹³è¡¡", false);
};
function backToShopping() {
    state.stage = 'shopping';
    document.getElementById('basket-panel').classList.remove('disabled');
    document.getElementById('weigh-panel').classList.add('disabled');
    document.getElementById('market-stall').classList.remove('disabled');
    updateInstruction("è¯·æ”¾å…¥èœå“", false);
}
document.getElementById('btn-submit').onclick = () => {
    const val = parseInt(document.getElementById('weight-input').value);
    if(isNaN(val)) return;
    const actual = state.totalWeight;
    const diff = Math.abs(val - actual); // ç»å¯¹è¯¯å·®

    let title = "ç§°é”™äº†"; let isWin = false; let scoreAdd = 0;
    let rank = "";

    if (diff <= 10) { 
        title = "ç¥å‡†ï¼"; isWin = true; scoreAdd = 100; rank="è¯¯å·®â‰¤10g (å®Œç¾)";
        state.game.streak++;
    } else if (diff <= 30) { 
        title = "ä¼˜ç§€ï¼"; isWin = true; scoreAdd = 50; rank="è¯¯å·®â‰¤30g (ä¼˜ç§€)";
        state.game.streak++;
    } else if (diff <= 50) { 
        title = "åˆæ ¼"; isWin = true; scoreAdd = 20; rank="è¯¯å·®â‰¤50g (åˆæ ¼)";
        state.game.streak = 0;
    } else {
        title = "å†æ¥å†å‰"; isWin = false; state.game.streak = 0;
        rank=`è¯¯å·® ${diff}g (å¤ªå¤§å•¦)`;
    }

    if(isWin) state.game.score += scoreAdd;
    showResult(title, `ä½ çš„è¯»æ•°: ${val}g<br>å®é™…é‡é‡: ${actual.toFixed(1)}g<br>${rank}`, isWin);
};

/* Vendor Logic - V10.1 Absolute Scoring */
function startVendorRound() {
    const item = ITEMS_DB[Math.floor(Math.random() * ITEMS_DB.length)];
    const targetW = Math.floor((Math.random() * 25) + 3) * 100; 
    state.vendorTarget = { weight: targetW, itemName: item.name, itemId: item.id };
    document.getElementById('vendor-order-display').innerHTML = `è®¢å•: ${targetW}g ${item.name}`;
    state.physics.weightPos = 20; 
    updateInstruction(`è¯·æ·»åŠ  ${item.name} å¹¶æ‰‹åŠ¨ç§°é‡`, false);
    updateBasketUI();
}
document.getElementById('btn-vendor-done').onclick = () => {
    const target = state.vendorTarget.weight;
    const actual = state.totalWeight;
    const diff = Math.abs(actual - target);

    let title = ""; let isWin = false;
    if(diff <= 20) {
        title = "å®Œç¾æˆäº¤"; isWin = true; state.game.score += 100;
        showResult(title, `ç›®æ ‡: ${target}g<br>å®ç»™: ${actual}g<br>è¯¯å·®ä»… ${diff}g`, true);
    } else if (diff <= 50) {
        title = "åŸºæœ¬æˆäº¤"; isWin = true; state.game.score += 30;
        showResult(title, `ç›®æ ‡: ${target}g<br>å®ç»™: ${actual}g<br>è¯¯å·® ${diff}g (è¿˜å¥½)`, true);
    } else {
        title = "ç”Ÿæ„å¤±è´¥"; 
        showResult(title, `ç›®æ ‡: ${target}g<br>å®ç»™: ${actual}g<br>ç›¸å·® ${diff}g (è¿™ç”Ÿæ„æ²¡æ³•åš)`, false);
    }
};
document.getElementById('btn-vendor-haggle-mode').onclick = () => {
    if(state.totalWeight === 0) return showToast("è¿˜æ²¡ç§°ä¸œè¥¿å‘¢ï¼");
    document.getElementById('vendor-main-btns').style.display = 'none';
    document.getElementById('vendor-haggle-panel').style.display = 'block';
    document.getElementById('vendor-op-panel').classList.add('highlight');
    setTimeout(() => document.getElementById('haggle-input').focus(), 100);
};
document.getElementById('btn-haggle-cancel').onclick = () => {
    document.getElementById('vendor-main-btns').style.display = 'block';
    document.getElementById('vendor-haggle-panel').style.display = 'none';
    document.getElementById('vendor-op-panel').classList.remove('highlight');
};
document.getElementById('btn-haggle-confirm').onclick = () => {
    const actual = state.totalWeight;
    const val = parseInt(document.getElementById('haggle-input').value);
    if(isNaN(val)) return showToast("è¯·è¾“å…¥æ•°å­—");
    const diff = Math.abs(val - actual);
    
    if(diff <= 30) {
        state.game.score += 50;
        showResult("åå•†æˆäº¤", `å®é™…: ${actual}g<br>ä½ ç®—çš„: ${val}g<br>è¯¯å·® ${diff}g<br>é¡¾å®¢è§‰å¾—ä½ æŒºè¯šå®`, true);
    } else {
        showResult("åå•†å¤±è´¥", `å®é™…: ${actual}g<br>ä½ ç®—çš„: ${val}g<br>è¯¯å·® ${diff}g<br>é¡¾å®¢è§‰å¾—ä½ åœ¨å‘äººï¼`, false);
    }
};

initMarket();
resizeCanvas();
loop();
</script>
</body>
</html>